{"version":3,"sources":["../../../../src/lib/services/fee-service.ts"],"sourcesContent":["import { Firestore, collection, doc, getDoc, getDocs, query, setDoc, where, writeBatch } from \"firebase/firestore\";\r\n\r\nexport async function syncAllStudentLedgers(db: Firestore) {\r\n    // 1. Fetch Necessary Data in Parallel\r\n    const [studentsSnap, customFeesSnap, configSnap, classesSnap, ledgersSnap] = await Promise.all([\r\n        getDocs(query(collection(db, \"students\"), where(\"status\", \"==\", \"ACTIVE\"))),\r\n        getDocs(query(collection(db, \"custom_fees\"), where(\"status\", \"==\", \"ACTIVE\"))),\r\n        getDoc(doc(db, \"config\", \"fees\")),\r\n        getDocs(query(collection(db, \"master_classes\"))),\r\n        getDocs(collection(db, \"student_fee_ledgers\"))\r\n    ]);\r\n\r\n    const students = studentsSnap.docs.map(d => ({ id: d.id, ...d.data() } as any));\r\n    const activeCustomFees = customFeesSnap.docs.map(d => ({ id: d.id, ...d.data() } as any));\r\n    const feeConfig = configSnap.exists() ? configSnap.data() : { terms: [], transportFees: {} };\r\n    const activeTerms = (feeConfig?.terms || []).filter((t: any) => t.isActive);\r\n\r\n    // Map existing ledgers for O(1) lookup\r\n    const existingLedgersMap = new Map();\r\n    ledgersSnap.docs.forEach(d => existingLedgersMap.set(d.id, d.data()));\r\n\r\n    // Map Class ID to Name\r\n    const classMap = new Map();\r\n    classesSnap.docs.forEach(doc => {\r\n        classMap.set(doc.id, doc.data().name);\r\n    });\r\n\r\n    let updatedCount = 0;\r\n    const currentYearId = \"2025-2026\";\r\n\r\n    // Firestore batch limit is 500. We'll use batches of 400 to be safe.\r\n    let batch = writeBatch(db);\r\n    let batchCount = 0;\r\n\r\n    for (const student of students) {\r\n        const ledgerId = `${student.schoolId}_${currentYearId}`;\r\n        const ledgerRef = doc(db, \"student_fee_ledgers\", ledgerId);\r\n        const existingLedger = existingLedgersMap.get(ledgerId);\r\n\r\n        let existingItems = existingLedger?.items || [];\r\n        let totalPaid = existingLedger?.totalPaid || 0;\r\n\r\n        // CALCULATION LOGIC\r\n        const targetClassId = student.classId;\r\n        const targetClassName = classMap.get(targetClassId) || student.className || \"Class 1\";\r\n\r\n        const newItems: any[] = [];\r\n        const newItemIds = new Set();\r\n\r\n        // A. Terms\r\n        activeTerms.forEach((term: any) => {\r\n            const amount = term.amounts?.[targetClassName] || 0;\r\n            if (amount > 0) {\r\n                const itemId = `TERM_${term.id}`;\r\n                newItems.push({\r\n                    id: itemId, type: \"TERM\", name: term.name, dueDate: term.dueDate,\r\n                    amount: Number(amount), paidAmount: 0, status: \"PENDING\"\r\n                });\r\n                newItemIds.add(itemId);\r\n            }\r\n        });\r\n\r\n        // B. Custom Fees\r\n        activeCustomFees.forEach((cf: any) => {\r\n            let isApplicable = false;\r\n            if (cf.targetType === \"CLASS\" && cf.targetIds?.includes(targetClassId)) isApplicable = true;\r\n            if (cf.targetType === \"VILLAGE\" && cf.targetIds?.includes(student.villageId)) isApplicable = true;\r\n            if (cf.targetType === \"STUDENT\" && cf.targetIds?.includes(student.schoolId)) isApplicable = true;\r\n\r\n            if (isApplicable) {\r\n                const itemId = `CUSTOM_${cf.id}`;\r\n                newItems.push({\r\n                    id: itemId, type: \"CUSTOM\", name: cf.name, dueDate: cf.dueDate,\r\n                    amount: Number(cf.amount), paidAmount: 0, status: \"PENDING\"\r\n                });\r\n                newItemIds.add(itemId);\r\n            }\r\n        });\r\n\r\n        // C. Transport Fee\r\n        const transportFeeAmount = (student.transportRequired && student.villageId) ? feeConfig?.transportFees?.[student.villageId] : 0;\r\n        if (transportFeeAmount > 0) {\r\n            const itemId = `TRANSPORT_FEE`;\r\n            newItems.push({\r\n                id: itemId, type: \"TRANSPORT\", name: \"Transport Fee\",\r\n                dueDate: `${currentYearId.split('-')[0]}-06-01`, amount: Number(transportFeeAmount), paidAmount: 0, status: \"PENDING\"\r\n            });\r\n            newItemIds.add(itemId);\r\n        }\r\n\r\n        // D. Merge Logic\r\n        let mergedItems = existingItems.filter((item: any) => {\r\n            if (item.paidAmount > 0) return true;\r\n            return newItemIds.has(item.id);\r\n        });\r\n\r\n        newItems.forEach(newItem => {\r\n            const existingIndex = mergedItems.findIndex((i: any) => i.id === newItem.id);\r\n            if (existingIndex === -1) {\r\n                mergedItems.push(newItem);\r\n            } else {\r\n                const ex = mergedItems[existingIndex];\r\n                if (ex.paidAmount === 0) {\r\n                    mergedItems[existingIndex] = { ...ex, amount: newItem.amount, dueDate: newItem.dueDate, name: newItem.name };\r\n                } else {\r\n                    mergedItems[existingIndex] = { ...ex, dueDate: newItem.dueDate, name: newItem.name };\r\n                }\r\n            }\r\n        });\r\n\r\n        const totalFee = mergedItems.reduce((sum: number, i: any) => sum + i.amount, 0);\r\n\r\n        batch.set(ledgerRef, {\r\n            studentId: student.schoolId,\r\n            studentName: student.studentName || \"Unknown\",\r\n            parentName: student.parentName || \"\",\r\n            parentMobile: student.parentMobile || student.mobile || \"\",\r\n            villageName: student.villageName || \"\",\r\n            academicYearId: currentYearId,\r\n            classId: student.classId || \"\",\r\n            className: student.className || \"\",\r\n            totalFee,\r\n            totalPaid,\r\n            status: totalPaid >= totalFee ? \"PAID\" : \"PENDING\",\r\n            items: mergedItems,\r\n            updatedAt: new Date().toISOString()\r\n        }, { merge: true });\r\n\r\n        batchCount++;\r\n        updatedCount++;\r\n\r\n        // Commit batch if it reaches limit\r\n        if (batchCount >= 400) {\r\n            await batch.commit();\r\n            batch = writeBatch(db);\r\n            batchCount = 0;\r\n        }\r\n    }\r\n\r\n    // Final commit\r\n    if (batchCount > 0) {\r\n        await batch.commit();\r\n    }\r\n\r\n    return updatedCount;\r\n}\r\n\r\n"],"names":[],"mappings":"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"}