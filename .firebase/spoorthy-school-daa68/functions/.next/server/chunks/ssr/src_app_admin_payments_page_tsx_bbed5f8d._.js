module.exports=[53084,a=>{"use strict";var b=a.i(87924),c=a.i(72131);a.i(69387);var d=a.i(60574),e=a.i(20237),f=a.i(89402),g=a.i(96221),h=a.i(15618),i=a.i(87532),j=a.i(210),k=a.i(71931),l=a.i(64550),m=a.i(99570),n=a.i(14574),o=a.i(66718),p=a.i(70430),q=a.i(80701),r=a.i(56025),s=a.i(91410);function t(){let{user:a}=(0,r.useAuth)(),[t,u]=(0,c.useState)([]),[v,w]=(0,c.useState)(!0),[x,y]=(0,c.useState)(!1),{branding:z}=(0,s.useMasterData)(),[A,B]=(0,c.useState)("");(0,c.useEffect)(()=>{if(!a)return;let b=(0,d.onSnapshot)((0,d.doc)(e.db,"users",a.uid),a=>{a.exists()&&B(a.data().role)});return()=>b()},[a]);let[C,D]=(0,c.useState)(""),[E,F]=(0,c.useState)([]),[G,H]=(0,c.useState)([]),[I,J]=(0,c.useState)(null),[K,L]=(0,c.useState)(null),[M,N]=(0,c.useState)({amount:"",method:"cash",date:new Date().toISOString().split("T")[0],remarks:""}),[O,P]=(0,c.useState)(!1);(0,c.useEffect)(()=>{let a=!0,b=(0,d.query)((0,d.collection)(e.db,"payments"),(0,d.orderBy)("date","desc"),(0,d.limit)(50)),c=(0,d.onSnapshot)(b,b=>{a&&(u(b.docs.map(a=>({id:a.id,...a.data()}))),w(!1))},b=>{a&&(console.error("Payments listener error:",b),w(!1))}),f=(0,d.query)((0,d.collection)(e.db,"students"),(0,d.orderBy)("studentName","asc")),g=(0,d.onSnapshot)(f,b=>{a&&F(b.docs.map(a=>({id:a.id,...a.data()})))},b=>{a&&console.error("Students list listener error:",b)});return()=>{a=!1,c(),g()}},[]);let Q=async a=>{J(a),D(""),H([]);try{let b=(0,d.doc)(e.db,"student_fee_ledgers",`${a.schoolId}_2025-2026`),c=await (0,d.getDoc)(b);c.exists()?L(c.data()):L(null)}catch(a){console.error("Error fetching ledger:",a),L(null)}},R=async a=>{if(a.preventDefault(),I){P(!0);try{let a=Number(M.amount);if(a<=0)throw Error("Invalid Amount");let b={studentId:I.schoolId,studentName:I.studentName,amount:a,method:M.method,date:d.Timestamp.fromDate(new Date(M.date)),status:"success",remarks:M.remarks,createdAt:d.Timestamp.now(),verifiedBy:"admin"};await (0,d.addDoc)((0,d.collection)(e.db,"payments"),b);let c=(0,d.doc)(e.db,"student_fee_ledgers",`${I.schoolId}_2025-2026`),f=(K?.totalPaid||0)+a,g=K?.totalFee||0;if(await (0,d.updateDoc)(c,{totalPaid:f,status:f>=g?"PAID":"PENDING",updatedAt:new Date().toISOString()}),I.uid)try{await (0,d.addDoc)((0,d.collection)(e.db,"notifications"),{userId:I.uid,title:"Fee Payment Received",message:`Payment of ₹${a.toLocaleString()} received via ${M.method}. ${M.remarks?`(${M.remarks})`:""}`,type:"PAYMENT_RECEIVED",status:"UNREAD",createdAt:d.Timestamp.now(),read:!1})}catch(a){console.error("Failed to notify student",a)}try{await (0,d.addDoc)((0,d.collection)(e.db,"notifications"),{target:"ALL_ADMINS",title:"Fee Collected",message:`Collected ₹${a.toLocaleString()} from ${I.studentName} (${I.schoolId}) via ${M.method}.`,type:"PAYMENT_COLLECTED",status:"UNREAD",createdAt:d.Timestamp.now(),read:!1})}catch(a){console.error("Failed to notify admins",a)}y(!1),N({amount:"",method:"cash",date:new Date().toISOString().split("T")[0],remarks:""}),J(null),L(null),alert("Payment Recorded & Ledger Updated")}catch(a){console.error(a),alert(a.message)}finally{P(!1)}}},S=K?(K.totalFee||0)-(K.totalPaid||0):0,T=async a=>{try{let b=(0,d.doc)(e.db,"students",a.studentId),c=await (0,d.getDoc)(b),f=c.exists()?{id:c.id,...c.data()}:{studentName:a.studentName,schoolId:a.studentId,className:"N/A"},g=(0,d.doc)(e.db,"student_fee_ledgers",`${a.studentId}_2025-2026`),h=await (0,d.getDoc)(g),i=h.exists()?h.data():{totalFee:0,totalPaid:0};(0,l.printPaymentReceipt)({payment:a,student:f,ledger:i,schoolLogo:z?.schoolLogo,schoolName:z?.schoolName})}catch(a){console.error(a),alert("Failed to fetch receipt data")}},U=[{key:"studentId",header:"Student ID",render:a=>(0,b.jsx)("span",{className:"font-mono text-xs",children:a.studentId})},{key:"studentName",header:"Student Name"},{key:"amount",header:"Amount",render:a=>(0,b.jsxs)("span",{className:`font-mono font-medium ${"credit"===a.type?"text-green-500":"text-red-500"}`,children:["credit"===a.type?"+":"-"," ₹",a.amount.toLocaleString()]})},{key:"method",header:"Method",render:a=>(0,b.jsx)("span",{className:"capitalize text-xs text-muted-foreground border border-white/10 px-2 py-0.5 rounded",children:a.method})},{key:"status",header:"Status",render:a=>(0,b.jsx)("span",{className:"inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-green-500/10 text-green-500 capitalize",children:a.status})},{key:"date",header:"Date",render:a=>(0,b.jsx)("span",{className:"text-muted-foreground text-xs",children:a.date?.toDate?a.date.toDate().toLocaleDateString():"Just now"})},{key:"actions",header:"",render:a=>(0,b.jsx)(m.Button,{variant:"ghost",size:"icon",onClick:()=>T(a),title:"Print Receipt",className:"h-8 w-8 hover:bg-white/10",children:(0,b.jsx)(k.Printer,{className:"w-4 h-4"})})}],V=t.reduce((a,b)=>a+b.amount,0),W=t.filter(a=>"razorpay"===a.method).reduce((a,b)=>a+b.amount,0),X=t.filter(a=>"cash"===a.method).reduce((a,b)=>a+b.amount,0);return(0,b.jsxs)("div",{className:"space-y-4 md:space-y-6 animate-in fade-in duration-500 max-w-none p-0 pb-20",children:[(0,b.jsxs)("div",{className:"flex flex-col md:flex-row md:items-center md:justify-between pt-2 md:pt-4 gap-4 md:gap-6 px-2 md:px-0",children:[(0,b.jsxs)("div",{className:"space-y-0.5 md:space-y-1",children:[(0,b.jsx)("h1",{className:"text-2xl md:text-5xl font-display font-bold bg-gradient-to-r from-white to-white/60 bg-clip-text text-transparent italic leading-tight",children:"Payments Ledger"}),(0,b.jsxs)("p",{className:"text-muted-foreground text-[10px] md:text-lg tracking-tight uppercase font-black opacity-50",children:["Tracking ",(0,b.jsx)("span",{className:"text-white",children:"incoming fee payments"})," and collections"]})]}),"MANAGER"!==A&&(0,b.jsxs)(n.Dialog,{open:x,onOpenChange:a=>{y(a),a||(J(null),D(""))},children:[(0,b.jsx)(n.DialogTrigger,{asChild:!0,children:(0,b.jsxs)(m.Button,{className:"h-10 md:h-12 w-full md:w-auto gap-2 bg-white text-black hover:bg-zinc-200 rounded-xl font-black uppercase tracking-tighter px-6 shadow-lg shadow-white/10 text-xs md:text-sm",children:[(0,b.jsx)(h.Plus,{size:16,className:"stroke-[3]"})," Record Fee"]})}),(0,b.jsxs)(n.DialogContent,{className:"bg-black/95 border-white/10 backdrop-blur-xl sm:max-w-md w-[95vw] rounded-2xl",children:[(0,b.jsx)(n.DialogHeader,{children:(0,b.jsx)(n.DialogTitle,{className:"text-xl font-display italic",children:I?`Collect: ${I.studentName}`:"Find Student"})}),I?(0,b.jsxs)("form",{onSubmit:R,className:"space-y-4 py-4",children:[(0,b.jsxs)(m.Button,{type:"button",variant:"ghost",size:"sm",className:"absolute left-4 top-4 h-6 px-2 text-xs text-muted-foreground hover:text-white",onClick:()=>J(null),children:[(0,b.jsx)(j.ArrowLeft,{className:"w-3 h-3 mr-1"})," Back"]}),(0,b.jsxs)("div",{className:"p-4 bg-emerald-500/10 border border-emerald-500/20 rounded-lg text-emerald-400 text-sm flex justify-between mt-2",children:[(0,b.jsx)("span",{children:"Current Due:"}),(0,b.jsxs)("span",{className:"font-bold font-mono",children:["₹",S.toLocaleString()]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsxs)(p.Label,{children:["Amount Received (₹) ",(0,b.jsx)("span",{className:"text-red-500",children:"*"})]}),(0,b.jsx)(o.Input,{required:!0,type:"number",min:"1",placeholder:"Enter amount...",className:"bg-white/5 border-white/10 font-mono text-lg",value:M.amount,onChange:a=>N({...M,amount:a.target.value}),autoFocus:!0})]}),(0,b.jsxs)("div",{className:"grid grid-cols-2 gap-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(p.Label,{children:"Payment Mode"}),(0,b.jsxs)(q.Select,{value:M.method,onValueChange:a=>N({...M,method:a}),children:[(0,b.jsx)(q.SelectTrigger,{className:"bg-white/5 border-white/10",children:(0,b.jsx)(q.SelectValue,{})}),(0,b.jsxs)(q.SelectContent,{children:[(0,b.jsx)(q.SelectItem,{value:"cash",children:"Cash"}),(0,b.jsx)(q.SelectItem,{value:"upi",children:"UPI / GPay"}),(0,b.jsx)(q.SelectItem,{value:"cheque",children:"Cheque"}),(0,b.jsx)(q.SelectItem,{value:"bank_transfer",children:"Bank Transfer"})]})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(p.Label,{children:"Date"}),(0,b.jsx)(o.Input,{type:"date",required:!0,className:"bg-white/5 border-white/10",value:M.date,onChange:a=>N({...M,date:a.target.value})})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(p.Label,{children:"Remarks (Optional)"}),(0,b.jsx)(o.Input,{placeholder:"e.g. Receipt #123",className:"bg-white/5 border-white/10",value:M.remarks,onChange:a=>N({...M,remarks:a.target.value})})]}),(0,b.jsx)(n.DialogFooter,{children:(0,b.jsx)(m.Button,{type:"submit",disabled:O,className:"w-full bg-emerald-600 hover:bg-emerald-700",children:O?(0,b.jsx)(g.Loader2,{className:"animate-spin"}):"Confirm Payment"})})]}):(0,b.jsx)("div",{className:"space-y-4 py-4 relative mb-12",children:(0,b.jsxs)("div",{className:"space-y-2 relative",children:[(0,b.jsx)(p.Label,{className:"text-[10px] font-black uppercase tracking-widest text-muted-foreground",children:"Search Student"}),(0,b.jsxs)("div",{className:"relative",children:[(0,b.jsx)(i.Search,{className:"absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground"}),(0,b.jsx)(o.Input,{value:C,onChange:a=>(a=>{if(D(a),!a)return void H([]);let b=a.toLowerCase();H(E.filter(a=>a.schoolId&&a.schoolId.toLowerCase().includes(b)||a.studentName&&a.studentName.toLowerCase().includes(b)).slice(0,5))})(a.target.value),placeholder:"Type ID or Name...",className:"pl-9 h-11 bg-white/5 border-white/10 rounded-xl focus:ring-accent/30",autoFocus:!0})]}),G.length>0&&(0,b.jsx)("div",{className:"absolute z-50 w-full mt-1 bg-black/95 border border-white/10 rounded-lg shadow-2xl overflow-hidden backdrop-blur-xl",children:G.map(a=>(0,b.jsxs)("button",{onClick:()=>Q(a),className:"w-full px-4 py-3 text-left hover:bg-white/10 transition-colors flex items-center justify-between border-b border-white/5 last:border-0",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"font-bold text-sm text-white",children:a.studentName}),(0,b.jsx)("div",{className:"text-xs text-muted-foreground font-mono",children:a.schoolId})]}),(0,b.jsx)("div",{className:"text-[10px] text-accent uppercase tracking-wider",children:a.className})]},a.id))}),C&&0===G.length&&(0,b.jsx)("div",{className:"text-center p-4 text-sm text-muted-foreground",children:"No students found."})]})})]})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-3 gap-2 md:gap-6",children:[(0,b.jsx)("div",{className:"bg-black/20 border border-white/5 backdrop-blur-sm p-3 md:p-6 rounded-xl flex flex-col md:flex-row md:items-center justify-between text-center md:text-left",children:(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-[8px] md:text-sm text-muted-foreground uppercase font-black tracking-widest",children:"Total"}),(0,b.jsxs)("h3",{className:"text-sm md:text-2xl font-bold mt-0.5 md:mt-1 text-white italic truncate",children:["₹ ",V.toLocaleString()]})]})}),(0,b.jsx)("div",{className:"bg-black/20 border border-white/5 backdrop-blur-sm p-3 md:p-6 rounded-xl flex flex-col md:flex-row md:items-center justify-between text-center md:text-left",children:(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-[8px] md:text-sm text-muted-foreground uppercase font-black tracking-widest",children:"Online"}),(0,b.jsxs)("h3",{className:"text-sm md:text-2xl font-bold mt-0.5 md:mt-1 text-blue-400 italic truncate",children:["₹ ",W.toLocaleString()]})]})}),(0,b.jsx)("div",{className:"bg-black/20 border border-white/5 backdrop-blur-sm p-3 md:p-6 rounded-xl flex flex-col md:flex-row md:items-center justify-between text-center md:text-left",children:(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-[8px] md:text-sm text-muted-foreground uppercase font-black tracking-widest",children:"Cash"}),(0,b.jsxs)("h3",{className:"text-sm md:text-2xl font-bold mt-0.5 md:mt-1 text-emerald-400 italic truncate",children:["₹ ",X.toLocaleString()]})]})})]}),(0,b.jsx)(f.DataTable,{data:t,columns:U,isLoading:v})]})}a.s(["default",()=>t])}];

//# sourceMappingURL=src_app_admin_payments_page_tsx_bbed5f8d._.js.map