module.exports=[81269,a=>{"use strict";var b=a.i(87924),c=a.i(72131),d=a.i(56025),e=a.i(20237);a.i(69387);var f=a.i(60574),g=a.i(91119),h=a.i(99570),i=a.i(86304),j=a.i(89402),k=a.i(96221),l=a.i(33441),m=a.i(33508),n=a.i(14548),o=a.i(87532),p=a.i(71931),q=a.i(88110),r=a.i(91410),s=a.i(66718),t=a.i(80701),u=a.i(68114);function v({classId:a,sectionId:v,defaultDate:w}){let{user:x}=(0,d.useAuth)(),{classes:y,branding:z}=(0,r.useMasterData)(),[A,B]=(0,c.useState)([]),[C,D]=(0,c.useState)({}),[E,F]=(0,c.useState)(!0),[G,H]=(0,c.useState)(!1),[I,J]=(0,c.useState)(!1),[K,L]=(0,c.useState)(!1),[M,N]=(0,c.useState)(""),[O,P]=(0,c.useState)(!1),[Q,R]=(0,c.useState)([]),[S,T]=(0,c.useState)("ALL"),U=w||new Date().toISOString().split("T")[0];(0,c.useEffect)(()=>{a&&v&&(O?V():W())},[a,v,U,O,S]);let V=async()=>{F(!0);try{let b,c,d=(0,f.query)((0,f.collection)(e.db,"students"),(0,f.where)("classId","==",a),(0,f.where)("sectionId","==",v)),g=(await (0,f.getDocs)(d)).docs.map(a=>({id:a.id,studentName:a.data().studentName,rollNumber:a.data().rollNumber,schoolId:a.data().schoolId})).sort((a,b)=>(a.rollNumber||0)-(b.rollNumber||0)),h=new Date().getFullYear();"ALL"===S?(b=`${h}-01-01_${a}_${v}`,c=`${h}-12-31_${a}_${v}`):(b=`${h}-${S}-01_${a}_${v}`,c=`${h}-${S}-31_${a}_${v}`);let i=(0,f.query)((0,f.collection)(e.db,"attendance"),(0,f.where)((0,f.documentId)(),">=",b),(0,f.where)((0,f.documentId)(),"<=",c)),j=await (0,f.getDocs)(i),k={};j.docs.forEach(a=>{let b=a.data();b.records&&Object.entries(b.records).forEach(([a,b])=>{k[a]||(k[a]={total:0,present:0}),("P"===b||"A"===b)&&(k[a].total++,"P"===b&&k[a].present++)})});let l=g.map(a=>{let b=k[a.id]||{total:0,present:0};return{...a,totalDays:b.total,presentDays:b.present,percentage:b.total>0?(b.present/b.total*100).toFixed(1):"0.0"}});R(l),B(g)}catch(a){console.error("Stats error",a),(0,q.toast)({title:"Error",description:"Failed to load stats",type:"error"})}finally{F(!1)}},W=async()=>{F(!0);try{let b=(0,f.query)((0,f.collection)(e.db,"students"),(0,f.where)("classId","==",a),(0,f.where)("sectionId","==",v),(0,f.where)("status","==","ACTIVE")),c=(await (0,f.getDocs)(b)).docs.map(a=>({id:a.id,...a.data()})).sort((a,b)=>(a.rollNumber||0)-(b.rollNumber||0));B(c);let d=(0,f.query)((0,f.collection)(e.db,"student_leaves"),(0,f.where)("classId","==",a),(0,f.where)("status","==","APPROVED")),g=await (0,f.getDocs)(d),h=new Set;g.forEach(a=>{let b=a.data();b.fromDate<=U&&b.toDate>=U&&(!b.sectionId||b.sectionId===v)&&h.add(b.studentId)});let i=`${U}_${a}_${v}`,j=await (0,f.getDoc)((0,f.doc)(e.db,"attendance",i));if(j.exists())J(!0),D(j.data().records||{});else{J(!1);let a={};c.forEach(b=>{let c=h.has(b.id)||b.schoolId&&h.has(b.schoolId);a[b.id]=c?"A":"P"}),D(a)}}catch(a){console.error(a),(0,q.toast)({title:"Error",description:"Failed to fetch data.",type:"error"})}finally{F(!1)}},[X,Y]=(0,c.useState)(new Set),Z=async()=>{H(!0);try{let b=await fetch("/api/attendance/mark",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({classId:a,sectionId:v,date:U,records:C,markedBy:x?.uid,markedByName:x?.displayName||"Admin",isModification:I,touchedIds:Array.from(X)})}),c=await b.json();if(!c.success)throw Error(c.error);(0,q.toast)({title:I?"Attendance Updated":"Attendance Submitted",description:`Updated ${c.changesCount||0}. Sent ${c.notifCount||0} notifications.${c.skippedCount?` (${c.skippedCount} users have no account)`:""}`,type:"success"}),J(!0),L(!1),Y(new Set)}catch(a){console.error(a),(0,q.toast)({title:"Failed",description:a.message,type:"error"})}finally{H(!1)}},$=A.filter(a=>a.studentName.toLowerCase().includes(M.toLowerCase())||a.schoolId&&a.schoolId.toLowerCase().includes(M.toLowerCase())||a.rollNumber&&String(a.rollNumber).includes(M));if(E)return(0,b.jsx)("div",{className:"p-10 flex justify-center",children:(0,b.jsx)(k.Loader2,{className:"animate-spin"})});let _={total:A.length,present:Object.values(C).filter(a=>"P"===a).length,absent:Object.values(C).filter(a=>"A"===a).length};return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,b.jsx)(g.Card,{className:"bg-black/20 border-white/10 overflow-hidden",children:(0,b.jsxs)("div",{className:"p-4 flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-xs text-muted-foreground uppercase",children:"Total"}),(0,b.jsx)("div",{className:"text-2xl font-bold",children:_.total})]}),(0,b.jsx)("div",{className:"w-10 h-10 rounded-full bg-blue-500/10 flex items-center justify-center text-blue-500",children:(0,b.jsx)(l.Check,{className:"w-5 h-5"})})]})}),(0,b.jsx)(g.Card,{className:"bg-black/20 border-white/10 overflow-hidden",children:(0,b.jsxs)("div",{className:"p-4 flex items-center justify-between border-l-4 border-emerald-500",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-xs text-muted-foreground uppercase",children:"Present"}),(0,b.jsx)("div",{className:"text-2xl font-bold text-emerald-500",children:_.present})]}),(0,b.jsx)("div",{className:"w-10 h-10 rounded-full bg-emerald-500/10 flex items-center justify-center text-emerald-500",children:(0,b.jsx)(l.Check,{className:"w-5 h-5"})})]})}),(0,b.jsx)(g.Card,{className:"bg-black/20 border-white/10 overflow-hidden",children:(0,b.jsxs)("div",{className:"p-4 flex items-center justify-between border-l-4 border-red-500",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"text-xs text-muted-foreground uppercase",children:"Absent"}),(0,b.jsx)("div",{className:"text-2xl font-bold text-red-500",children:_.absent})]}),(0,b.jsx)("div",{className:"w-10 h-10 rounded-full bg-red-500/10 flex items-center justify-center text-red-500",children:(0,b.jsx)(m.X,{className:"w-5 h-5"})})]})})]}),(0,b.jsxs)(g.Card,{className:"bg-black/20 border-white/10",children:[(0,b.jsxs)("div",{className:"p-4 border-b border-white/10 flex flex-col md:flex-row justify-between gap-4 items-center",children:[(0,b.jsxs)("div",{className:"flex bg-black/40 p-1 rounded-lg border border-white/10 items-center gap-2",children:[(0,b.jsx)(h.Button,{variant:"ghost",size:"sm",onClick:()=>P(!1),className:O?"text-muted-foreground hover:text-white":"bg-emerald-500/20 text-emerald-500",children:"Daily View"}),(0,b.jsx)(h.Button,{variant:"ghost",size:"sm",onClick:()=>P(!0),className:O?"bg-blue-500/20 text-blue-500":"text-muted-foreground hover:text-white",children:"Overall Stats"}),O&&(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)(t.Select,{value:S,onValueChange:T,children:[(0,b.jsx)(t.SelectTrigger,{className:"w-[140px] h-8 bg-transparent border-white/10 text-xs",children:(0,b.jsx)(t.SelectValue,{placeholder:"Period"})}),(0,b.jsxs)(t.SelectContent,{className:"bg-slate-900 border-white/10",children:[(0,b.jsxs)(t.SelectItem,{value:"ALL",children:["Full Year ",new Date().getFullYear()]}),(0,b.jsx)(t.SelectItem,{value:"01",children:"January"}),(0,b.jsx)(t.SelectItem,{value:"02",children:"February"}),(0,b.jsx)(t.SelectItem,{value:"03",children:"March"}),(0,b.jsx)(t.SelectItem,{value:"04",children:"April"}),(0,b.jsx)(t.SelectItem,{value:"05",children:"May"}),(0,b.jsx)(t.SelectItem,{value:"06",children:"June"}),(0,b.jsx)(t.SelectItem,{value:"07",children:"July"}),(0,b.jsx)(t.SelectItem,{value:"08",children:"August"}),(0,b.jsx)(t.SelectItem,{value:"09",children:"September"}),(0,b.jsx)(t.SelectItem,{value:"10",children:"October"}),(0,b.jsx)(t.SelectItem,{value:"11",children:"November"}),(0,b.jsx)(t.SelectItem,{value:"12",children:"December"})]})]}),(0,b.jsxs)(h.Button,{size:"sm",variant:"outline",className:"h-8 border-white/10 hover:bg-white/5 gap-2 px-3",onClick:()=>{let b=y.find(b=>b.id===a),c="ALL"===S?`Annual Report ${new Date().getFullYear()}`:`Monthly Report - ${new Date(2e3,Number(S)-1).toLocaleString("default",{month:"long"})} ${new Date().getFullYear()}`,d=`
            <html>
            <head>
                <title>Student Attendance Report - ${b?.name} - ${c}</title>
                <style>
                    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; color: #333; }
                    .header { display: flex; align-items: center; justify-content: center; gap: 30px; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                    .logo { height: 80px; width: auto; object-fit: contain; }
                    .header-text { text-align: left; }
                    h1 { margin: 0; font-size: 28px; }
                    .details { font-size: 14px; color: #666; margin-top: 2px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
                    th { background-color: #f8f9fa; font-weight: bold; text-transform: uppercase; font-size: 12px; }
                    .text-center { text-align: center; }
                    .font-bold { font-weight: bold; }
                    .percentage { font-weight: bold; }
                    .low { color: #dc3545; }
                    .good { color: #28a745; }
                    .footer { margin-top: 50px; display: flex; justify-content: space-between; font-size: 12px; color: #666; }
                </style>
            </head>
            <body>
                <div class="header">
                    ${z?.schoolLogo?`<img src="${z.schoolLogo}" class="logo" />`:""}
                    <div class="header-text">
                        <h1 style="margin: 0;">${z?.schoolName||"Attendance Report"}</h1>
                        <div class="details" style="font-weight: bold; color: #333;">Student Attendance Report</div>
                        <div class="details">Class: ${b?.name} (${v}) - ${c}</div>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th style="width: 40px;">Roll</th>
                            <th>Student Name</th>
                            <th class="text-center">ID</th>
                            <th class="text-center">Total Days</th>
                            <th class="text-center">Present</th>
                            <th class="text-center">Absents</th>
                            <th class="text-center">Attendance %</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${Q.map((a,b)=>`
                            <tr>
                                <td>${a.rollNumber||b+1}</td>
                                <td class="font-bold">${a.studentName}</td>
                                <td class="text-center">${a.schoolId}</td>
                                <td class="text-center">${a.totalDays}</td>
                                <td class="text-center" style="color: #28a745; font-weight: bold;">${a.presentDays}</td>
                                <td class="text-center">${a.totalDays-a.presentDays}</td>
                                <td class="text-center percentage ${75>Number(a.percentage)?"low":"good"}">${a.percentage}%</td>
                            </tr>
                        `).join("")}
                    </tbody>
                </table>
                <div class="footer">
                    <div>Generated on: ${new Date().toLocaleString()}</div>
                    <div>School Management System</div>
                </div>
                <script>
                    window.onload = () => {
                        window.print();
                        window.onafterprint = () => window.close();
                    };
                </script>
            </body>
            </html>
        `,e=window.open("","_blank");e?.document.write(d),e?.document.close()},children:[(0,b.jsx)(p.Printer,{className:"w-3 h-3"})," Print Report"]})]})]}),!O&&(0,b.jsxs)("div",{className:"relative flex-1 w-full md:max-w-xs",children:[(0,b.jsx)(o.Search,{className:"absolute left-2 top-2.5 h-4 w-4 text-muted-foreground"}),(0,b.jsx)(s.Input,{placeholder:"Search students...",value:M,onChange:a=>N(a.target.value),className:"pl-8 bg-black/40 border-white/10 w-full"})]})]}),(0,b.jsx)(g.CardContent,{className:"p-0",children:(0,b.jsx)(j.DataTable,{data:O?Q:$,isLoading:E,columns:O?[{key:"rollNumber",header:"Roll",render:(a,c)=>(0,b.jsx)("span",{className:"font-mono text-sm",children:a.rollNumber||(c??0)+1})},{key:"studentName",header:"Student Name",render:a=>(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"font-medium text-white",children:a.studentName}),(0,b.jsx)("div",{className:"text-[10px] text-white/40 uppercase",children:a.schoolId})]})},{key:"totalDays",header:"Total",cellClassName:"text-center",render:a=>(0,b.jsx)("span",{className:"font-mono",children:a.totalDays})},{key:"presentDays",header:"Present",cellClassName:"text-center",render:a=>(0,b.jsx)("span",{className:"font-bold text-emerald-400",children:a.presentDays})},{key:"percentage",header:"Attendance %",cellClassName:"text-center",render:a=>(0,b.jsxs)("div",{className:"flex flex-col items-center min-w-[80px]",children:[(0,b.jsxs)("span",{className:`font-bold ${75>Number(a.percentage)?"text-red-400":"text-emerald-400"}`,children:[a.percentage,"%"]}),(0,b.jsx)("div",{className:"w-full h-1 bg-white/10 rounded-full mt-1 overflow-hidden max-w-[60px]",children:(0,b.jsx)("div",{className:`h-full ${75>Number(a.percentage)?"bg-red-500":"bg-emerald-500"}`,style:{width:`${a.percentage}%`}})})]})},{key:"statsStatus",header:"Status",cellClassName:"text-right",render:a=>(0,b.jsx)(i.Badge,{variant:"outline",className:(0,u.cn)("text-[8px] uppercase font-black tracking-tighter",75>Number(a.percentage)?"text-red-400 border-red-500/30":"text-emerald-400 border-emerald-500/30"),children:75>Number(a.percentage)?"Low":"Good"})}]:[{key:"rollNumber",header:"Roll",render:(a,c)=>(0,b.jsx)("span",{className:"font-mono text-sm",children:a.rollNumber||(c??0)+1})},{key:"studentName",header:"Student Name",render:a=>(0,b.jsxs)("div",{children:[(0,b.jsx)("div",{className:"font-medium text-white",children:a.studentName}),(0,b.jsx)("div",{className:"text-[10px] text-white/40 uppercase",children:a.schoolId})]})},{key:"attendanceStatus",header:"Status",cellClassName:"text-center",render:a=>(0,b.jsx)(i.Badge,{className:(0,u.cn)("font-black uppercase tracking-tighter text-[9px]","P"===C[a.id]?"bg-emerald-500/10 text-emerald-500 border border-emerald-500/20":"bg-red-500/10 text-red-500 border border-red-500/20"),children:"P"===C[a.id]?"Present":"Absent"})},{key:"action",header:"Action",cellClassName:"text-right",render:a=>(0,b.jsx)(h.Button,{size:"sm",variant:"ghost",className:(0,u.cn)("h-8 text-[10px] font-black uppercase tracking-tighter px-3 rounded-lg","P"===C[a.id]?"bg-red-500/10 text-red-400 hover:bg-red-500 hover:text-white":"bg-emerald-500/10 text-emerald-400 hover:bg-emerald-500 hover:text-white"),onClick:()=>{var b;return b=a.id,void(D(a=>({...a,[b]:"P"===a[b]?"A":"P"})),Y(a=>{let c=new Set(a);return c.add(b),c}),L(!0))},children:"P"===C[a.id]?"Mark Absent":"Mark Present"})}]})})]}),!O&&(0,b.jsxs)("div",{className:"flex justify-between items-center bg-white/5 p-4 rounded-lg border border-white/10",children:[(0,b.jsx)("div",{className:"text-sm text-muted-foreground",children:I?K?"You have unsaved changes.":`Attendance already marked by ${x?.uid==="admin"?"Admin":"Teacher"}`:"Ready to submit."}),(0,b.jsxs)(h.Button,{size:"lg",onClick:Z,disabled:G||I&&!K,className:"bg-emerald-600 hover:bg-emerald-700 text-white min-w-[200px]",children:[G?(0,b.jsx)(k.Loader2,{className:"w-5 h-5 animate-spin mr-2"}):(0,b.jsx)(n.Save,{className:"w-5 h-5 mr-2"}),I?"Update Attendance":"Submit Attendance"]})]})]})}a.s(["default",()=>v])}];

//# sourceMappingURL=src_components_attendance_attendance-manager_tsx_582f5fe4._.js.map