{"version":3,"sources":["../../../../src/app/student/notifications/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useEffect, useState } from \"react\";\r\nimport { useAuth } from \"@/context/AuthContext\";\r\nimport { Card, CardContent } from \"@/components/ui/card\";\r\nimport { collection, query, where, getDocs, orderBy, onSnapshot, limit, updateDoc, doc } from \"firebase/firestore\";\r\nimport { db } from \"@/lib/firebase\";\r\nimport { Loader2, Bell, CheckCircle } from \"lucide-react\";\r\nimport { cn } from \"@/lib/utils\";\r\n\r\ninterface Notification {\r\n    id: string;\r\n    title: string;\r\n    message: string;\r\n    type: string;\r\n    status: \"READ\" | \"UNREAD\";\r\n    createdAt: any;\r\n}\r\n\r\nexport default function StudentNotificationsPage() {\r\n    const { user } = useAuth();\r\n    const [notifications, setNotifications] = useState<Notification[]>([]);\r\n    const [loading, setLoading] = useState(true);\r\n\r\n    useEffect(() => {\r\n        if (!user) return;\r\n\r\n        let isMounted = true;\r\n        const unsubscribes: (() => void)[] = [];\r\n\r\n        const startListeners = async () => {\r\n            if (!user?.uid) return;\r\n\r\n            // 1. Personal Notifications - Realtime\r\n            const qPersonal = query(collection(db, \"notifications\"), where(\"userId\", \"==\", user.uid), limit(50));\r\n            const unsubPersonal = onSnapshot(qPersonal, (snap) => {\r\n                if (!isMounted) return;\r\n                const list = snap.docs.map(d => ({ id: d.id, ...d.data() } as Notification));\r\n                updateNotifications(list, \"personal\");\r\n            });\r\n            unsubscribes.push(unsubPersonal);\r\n\r\n            // 2. Class Notifications - Realtime\r\n            try {\r\n                // Fetch class ID once\r\n                const sQuery = query(collection(db, \"students\"), where(\"uid\", \"==\", user.uid), limit(1));\r\n                const sSnap = await getDocs(sQuery);\r\n\r\n                if (!isMounted) return;\r\n\r\n                if (!sSnap.empty) {\r\n                    const studentData = sSnap.docs[0].data();\r\n                    const classId = studentData.classId;\r\n                    if (classId) {\r\n                        const qClass = query(collection(db, \"notifications\"), where(\"target\", \"==\", `class_${classId}`), limit(50));\r\n                        const unsubClass = onSnapshot(qClass, (snap) => {\r\n                            if (!isMounted) return;\r\n                            const list = snap.docs.map(d => ({ id: d.id, ...d.data() } as Notification));\r\n                            updateNotifications(list, \"class\");\r\n                        });\r\n                        unsubscribes.push(unsubClass);\r\n                    }\r\n                }\r\n            } catch (e) {\r\n                console.error(\"Error setting up class listeners:\", e);\r\n            }\r\n\r\n            setLoading(false);\r\n        };\r\n\r\n        // Helper to merge lists safely\r\n        const updateNotifications = (newList: Notification[], source: string) => {\r\n            if (!isMounted) return;\r\n            setNotifications(prev => {\r\n                // Remove existing items that are being updated by this new list\r\n                const newIds = new Set(newList.map(n => n.id));\r\n                const filteredPrev = prev.filter(p => !newIds.has(p.id));\r\n\r\n                // Combine and Sort\r\n                const combined = [...filteredPrev, ...newList];\r\n                return combined.sort((a, b) => {\r\n                    const timeA = a.createdAt?.seconds || 0;\r\n                    const timeB = b.createdAt?.seconds || 0;\r\n                    return timeB - timeA;\r\n                }).slice(0, 50);\r\n            });\r\n        };\r\n\r\n        startListeners();\r\n\r\n        return () => {\r\n            isMounted = false;\r\n            unsubscribes.forEach(f => f());\r\n        };\r\n    }, [user]);\r\n\r\n    const markAsRead = async (id: string, status: string) => {\r\n        // Prevent unnecessary writes\r\n        if (status === \"READ\") return;\r\n\r\n        try {\r\n            console.log(\"Marking as read:\", id);\r\n            await updateDoc(doc(db, \"notifications\", id), { status: \"READ\" });\r\n        } catch (e) {\r\n            console.error(\"Error marking read:\", e);\r\n        }\r\n    };\r\n\r\n    const formatTimestamp = (timestamp: any) => {\r\n        if (!timestamp) return '';\r\n        try {\r\n            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp.seconds * 1000);\r\n            return date.toLocaleString();\r\n        } catch (e) {\r\n            return '';\r\n        }\r\n    };\r\n\r\n    if (loading) return <div className=\"flex justify-center p-10\"><Loader2 className=\"animate-spin text-[#64FFDA]\" /></div>;\r\n\r\n    return (\r\n        <div className=\"max-w-4xl mx-auto space-y-6 animate-in fade-in pb-10\">\r\n            <div className=\"flex items-center gap-3 mb-6 border-b border-[#64FFDA]/10 pb-4\">\r\n                <div className=\"p-2 bg-[#64FFDA]/10 rounded-lg text-[#64FFDA]\">\r\n                    <Bell size={24} />\r\n                </div>\r\n                <div>\r\n                    <h1 className=\"text-3xl font-display font-bold text-white\">Notifications</h1>\r\n                    <p className=\"text-muted-foreground\">Updates on attendance, assignments, and system alerts.</p>\r\n                </div>\r\n            </div>\r\n\r\n            <div className=\"space-y-4\">\r\n                {notifications.length === 0 ? (\r\n                    <div className=\"text-center py-20 bg-white/5 rounded-xl border border-white/10\">\r\n                        <Bell className=\"mx-auto h-12 w-12 text-muted-foreground/50 mb-4\" />\r\n                        <p className=\"text-muted-foreground\">No notifications yet.</p>\r\n                    </div>\r\n                ) : (\r\n                    notifications.map(n => (\r\n                        <div\r\n                            key={n.id}\r\n                            onClick={() => markAsRead(n.id, n.status)}\r\n                            className={cn(\r\n                                \"bg-black/20 border border-white/10 rounded-lg transition-all hover:bg-white/5 cursor-pointer group relative overflow-hidden\",\r\n                                n.status === \"UNREAD\" ? \"border-l-4 border-l-[#3B82F6] bg-[#3B82F6]/5\" : \"opacity-80\"\r\n                            )}\r\n                        >\r\n                            <div className=\"p-5 flex gap-4\">\r\n                                <div className={cn(\r\n                                    \"mt-1 w-2 h-2 rounded-full flex-shrink-0\",\r\n                                    n.status === \"UNREAD\" ? \"bg-[#3B82F6]\" : \"bg-transparent\"\r\n                                )} />\r\n                                <div className=\"flex-1 space-y-1\">\r\n                                    <div className=\"flex justify-between items-start\">\r\n                                        <h3 className={cn(\"font-bold text-lg\", n.status === \"UNREAD\" ? \"text-white\" : \"text-muted-foreground\")}>\r\n                                            {n.title}\r\n                                        </h3>\r\n                                        <span suppressHydrationWarning className=\"text-xs text-muted-foreground whitespace-nowrap font-mono\">\r\n                                            {formatTimestamp(n.createdAt)}\r\n                                        </span>\r\n                                    </div>\r\n                                    <p className=\"text-sm text-muted-foreground leading-relaxed\">{n.message}</p>\r\n\r\n                                    {n.status === \"READ\" && (\r\n                                        <div className=\"flex items-center gap-1 text-[10px] text-green-500/50 mt-2 opacity-0 group-hover:opacity-100 transition-opacity\">\r\n                                            <CheckCircle size={10} /> Read\r\n                                        </div>\r\n                                    )}\r\n                                </div>\r\n                            </div>\r\n                        </div>\r\n                    ))\r\n                )}\r\n            </div>\r\n        </div>\r\n    );\r\n}\r\n"],"names":[],"mappings":"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"}