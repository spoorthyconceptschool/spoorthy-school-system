module.exports=[47649,a=>{"use strict";a.i(69387);var b=a.i(60574);async function c(a){let[c,d,e,f,g]=await Promise.all([(0,b.getDocs)((0,b.query)((0,b.collection)(a,"students"),(0,b.where)("status","==","ACTIVE"))),(0,b.getDocs)((0,b.query)((0,b.collection)(a,"custom_fees"),(0,b.where)("status","==","ACTIVE"))),(0,b.getDoc)((0,b.doc)(a,"config","fees")),(0,b.getDocs)((0,b.query)((0,b.collection)(a,"master_classes"))),(0,b.getDocs)((0,b.collection)(a,"student_fee_ledgers"))]),h=c.docs.map(a=>({id:a.id,...a.data()})),i=d.docs.map(a=>({id:a.id,...a.data()})),j=e.exists()?e.data():{terms:[],transportFees:{}},k=(j?.terms||[]).filter(a=>a.isActive),l=new Map;g.docs.forEach(a=>l.set(a.id,a.data()));let m=new Map;f.docs.forEach(a=>{m.set(a.id,a.data().name)});let n=0,o="2025-2026",p=(0,b.writeBatch)(a),q=0;for(let c of h){let d=`${c.schoolId}_${o}`,e=(0,b.doc)(a,"student_fee_ledgers",d),f=l.get(d),g=f?.items||[],h=f?.totalPaid||0,r=c.classId,s=m.get(r)||c.className||"Class 1",t=[],u=new Set;k.forEach(a=>{let b=a.amounts?.[s]||0;if(b>0){let c=`TERM_${a.id}`;t.push({id:c,type:"TERM",name:a.name,dueDate:a.dueDate,amount:Number(b),paidAmount:0,status:"PENDING"}),u.add(c)}}),i.forEach(a=>{let b=!1;if("CLASS"===a.targetType&&a.targetIds?.includes(r)&&(b=!0),"VILLAGE"===a.targetType&&a.targetIds?.includes(c.villageId)&&(b=!0),"STUDENT"===a.targetType&&a.targetIds?.includes(c.schoolId)&&(b=!0),b){let b=`CUSTOM_${a.id}`;t.push({id:b,type:"CUSTOM",name:a.name,dueDate:a.dueDate,amount:Number(a.amount),paidAmount:0,status:"PENDING"}),u.add(b)}});let v=c.transportRequired&&c.villageId?j?.transportFees?.[c.villageId]:0;if(v>0){let a="TRANSPORT_FEE";t.push({id:a,type:"TRANSPORT",name:"Transport Fee",dueDate:`${o.split("-")[0]}-06-01`,amount:Number(v),paidAmount:0,status:"PENDING"}),u.add(a)}let w=g.filter(a=>a.paidAmount>0||u.has(a.id));t.forEach(a=>{let b=w.findIndex(b=>b.id===a.id);if(-1===b)w.push(a);else{let c=w[b];0===c.paidAmount?w[b]={...c,amount:a.amount,dueDate:a.dueDate,name:a.name}:w[b]={...c,dueDate:a.dueDate,name:a.name}}});let x=w.reduce((a,b)=>a+b.amount,0);p.set(e,{studentId:c.schoolId,studentName:c.studentName||"Unknown",parentName:c.parentName||"",parentMobile:c.parentMobile||c.mobile||"",villageName:c.villageName||"",academicYearId:o,classId:c.classId||"",className:c.className||"",totalFee:x,totalPaid:h,status:h>=x?"PAID":"PENDING",items:w,updatedAt:new Date().toISOString()},{merge:!0}),q++,n++,q>=400&&(await p.commit(),p=(0,b.writeBatch)(a),q=0)}return q>0&&await p.commit(),n}a.s(["syncAllStudentLedgers",()=>c])}];

//# sourceMappingURL=src_lib_services_fee-service_ts_1e519c71._.js.map