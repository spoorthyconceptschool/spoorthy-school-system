module.exports=[79733,e=>e.a(async(t,a)=>{try{var r=e.i(89171),s=e.i(73051),n=e.i(27817),i=t([n]);async function o(e){try{let t=e.headers.get("Authorization");if(!t?.startsWith("Bearer "))return r.NextResponse.json({error:"Unauthorized"},{status:401});let a=t.split("Bearer ")[1],i=await s.adminAuth.verifyIdToken(a),o="SUPER_ADMIN"===i.role||"ADMIN"===i.role||"admin"===i.role,l=i.email?.includes("admin")||i.email?.endsWith("@spoorthy.edu");if(!o&&!l)return r.NextResponse.json({error:"Insufficient Permissions"},{status:403});let{students:d}=await e.json();if(!d||!Array.isArray(d))return r.NextResponse.json({error:"Invalid data format"},{status:400});let u=d.slice(0,50);console.log(`Processing import batch of ${u.length} students...`);let c=(await s.adminRtdb.ref("master").once("value")).val()||{},p=c.classes||{},m=c.villages||{},h=c.sections||{},R=(await s.adminDb.collection("config").doc("fees").get()).data(),g=(R?.terms||[]).filter(e=>e.isActive),f="2025-2026",w=(await s.adminDb.collection("custom_fees").where("isActive","==",!0).get()).docs.map(e=>({id:e.id,...e.data()})),v={success:0,failed:0,errors:[],created:[]},E=1;await s.adminDb.runTransaction(async e=>{let t=s.adminDb.collection("counters").doc("students"),a=await e.get(t);a.exists&&(E=a.data()?.current+1),e.set(t,{current:E+u.length-1},{merge:!0})});for(let e=0;e<u.length;e++){let t=u[e],a=E+e,r=`SHS${String(a).padStart(5,"0")}`;try{if(!t.studentName||!t.classId)throw Error(`Missing Name or Class ID for row ${e+1}`);let a=p[t.classId]?.name||t.className||"Unknown Class",i=m[t.villageId]?.name||t.villageName||"Unknown Village",o=h[t.sectionId]?.name||t.sectionName||"",l=`${r}@school.local`.toLowerCase(),d=t.password||t.parentMobile||"welcome123",u="";try{u=(await s.adminAuth.createUser({email:l,password:String(d),displayName:t.studentName,disabled:!1})).uid}catch(e){if("auth/email-already-exists"===e.code)u=(await s.adminAuth.getUserByEmail(l)).uid,console.warn(`User ${l} already exists. Updating...`);else throw e}let c=s.adminDb.batch();c.set(s.adminDb.collection("users").doc(u),{schoolId:r,email:l,role:"STUDENT",status:"ACTIVE",createdAt:n.FieldValue.serverTimestamp(),mustChangePassword:!0,linkedProfileId:r},{merge:!0}),c.set(s.adminDb.collection("usersBySchoolId").doc(r),{uid:u,role:"STUDENT"}),c.set(s.adminDb.collection("students").doc(r),{...t,schoolId:r,uid:u,studentName:t.studentName,className:a,classId:t.classId,villageName:i,villageId:t.villageId||"",sectionName:o,sectionId:t.sectionId||"",status:"ACTIVE",createdAt:n.FieldValue.serverTimestamp(),email:l,recoveryPassword:String(d),transportRequired:!!t.transportRequired});let E=0,N=[];if(g.forEach(e=>{let t=e.amounts?.[a]||0;t>0&&(N.push({id:`TERM_${e.id}`,type:"TERM",name:e.name,dueDate:e.dueDate,amount:Number(t),paidAmount:0,status:"PENDING"}),E+=Number(t))}),t.transportRequired&&R?.transportFees?.[t.villageId]){let e=R.transportFees[t.villageId];e>0&&(N.push({id:"TRANSPORT_FEE",type:"TRANSPORT",name:"Transport Fee",dueDate:`${f.split("-")[0]}-06-01`,amount:Number(e),paidAmount:0,status:"PENDING"}),E+=Number(e))}w.filter(e=>e.targetClassId===t.classId).forEach(e=>{N.push({id:`CUSTOM_${e.id}`,type:"CUSTOM",name:e.name,dueDate:e.dueDate||new Date().toISOString().split("T")[0],amount:Number(e.amount),paidAmount:0,status:"PENDING"}),E+=Number(e.amount)});let A=s.adminDb.collection("student_fee_ledgers").doc(`${r}_${f}`);c.set(A,{studentId:r,academicYearId:f,classId:t.classId,className:a,totalFee:E,totalPaid:0,status:E>0?"PENDING":"PAID",items:N,createdAt:n.FieldValue.serverTimestamp(),updatedAt:n.FieldValue.serverTimestamp()});let I=new Set,y=e=>{if(!e)return;let t=String(e).toLowerCase().trim();I.add(t);let a=t.split(/\s+/);a.forEach(e=>I.add(e)),a.forEach(e=>{for(let t=2;t<=e.length;t++)I.add(e.substring(0,t))})};y(t.studentName),y(r),y(t.parentMobile),y(a),c.set(s.adminDb.collection("search_index").doc(r),{id:r,entityId:r,type:"student",title:t.studentName,subtitle:`${a} | ${t.parentMobile}`,url:`/admin/students/${r}`,keywords:Array.from(I),updatedAt:n.FieldValue.serverTimestamp()}),await c.commit(),v.success++,v.created.push({schoolId:r,name:t.studentName})}catch(a){console.error(`Import Error Row ${e}:`,a),v.failed++,v.errors.push(`${t.studentName||"Row "+(e+1)}: ${a.message}`)}}return r.NextResponse.json(v)}catch(e){return console.error("Import API Error:",e),r.NextResponse.json({error:e.message},{status:500})}}[n]=i.then?(await i)():i,e.s(["POST",()=>o]),a()}catch(e){a(e)}},!1),730,e=>e.a(async(t,a)=>{try{var r=e.i(47909),s=e.i(74017),n=e.i(96250),i=e.i(59756),o=e.i(61916),l=e.i(74677),d=e.i(69741),u=e.i(16795),c=e.i(87718),p=e.i(95169),m=e.i(47587),h=e.i(66012),R=e.i(70101),g=e.i(26937),f=e.i(10372),w=e.i(93695);e.i(52474);var v=e.i(220),E=e.i(79733),N=t([E]);[E]=N.then?(await N)():N;let y=new r.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/admin/students/import/route",pathname:"/api/admin/students/import",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/admin/students/import/route.ts",nextConfigOutput:"",userland:E}),{workAsyncStorage:T,workUnitAsyncStorage:b,serverHooks:C}=y;function A(){return(0,n.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:b})}async function I(e,t,a){y.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/admin/students/import/route";r=r.replace(/\/index$/,"")||"/";let n=await y.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!n)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:E,params:N,nextConfig:A,parsedUrl:I,isDraftMode:T,prerenderManifest:b,routerServerContext:C,isOnDemandRevalidate:x,revalidateOnlyGenerated:D,resolvedPathname:P,clientReferenceManifest:S,serverActionsManifest:_}=n,U=(0,d.normalizeAppPath)(r),O=!!(b.dynamicRoutes[U]||b.routes[P]),$=async()=>((null==C?void 0:C.render404)?await C.render404(e,t,I,!1):t.end("This page could not be found"),null);if(O&&!T){let e=!!b.routes[P],t=b.dynamicRoutes[U];if(t&&!1===t.fallback&&!e){if(A.experimental.adapterPath)return await $();throw new w.NoFallbackError}}let M=null;!O||y.isDev||T||(M=P,M="/index"===M?"/":M);let k=!0===y.isDev||!O,F=O&&!k;_&&S&&(0,l.setManifestsSingleton)({page:r,clientReferenceManifest:S,serverActionsManifest:_});let H=e.method||"GET",q=(0,o.getTracer)(),j=q.getActiveScopeSpan(),V={params:N,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!A.experimental.authInterrupts},cacheComponents:!!A.cacheComponents,supportsDynamicResponse:k,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:A.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,s)=>y.onRequestError(e,t,r,s,C)},sharedContext:{buildId:E}},B=new u.NodeNextRequest(e),K=new u.NodeNextResponse(t),G=c.NextRequestAdapter.fromNodeNextRequest(B,(0,c.signalFromNodeResponse)(t));try{let n=async e=>y.handle(G,V).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=q.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${H} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${r}`)}),l=!!(0,i.getRequestMeta)(e,"minimalMode"),d=async i=>{var o,d;let u=async({previousCacheEntry:s})=>{try{if(!l&&x&&D&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await n(i);e.fetchMetrics=V.renderOpts.fetchMetrics;let o=V.renderOpts.pendingWaitUntil;o&&a.waitUntil&&(a.waitUntil(o),o=void 0);let d=V.renderOpts.collectedTags;if(!O)return await (0,h.sendResponse)(B,K,r,V.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,R.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[f.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==V.renderOpts.collectedRevalidate&&!(V.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&V.renderOpts.collectedRevalidate,s=void 0===V.renderOpts.collectedExpire||V.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:V.renderOpts.collectedExpire;return{value:{kind:v.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await y.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:x})},!1,C),t}},c=await y.handleResponse({req:e,nextConfig:A,cacheKey:M,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:x,revalidateOnlyGenerated:D,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:l});if(!O)return null;if((null==c||null==(o=c.value)?void 0:o.kind)!==v.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",x?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,R.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&O||p.delete(f.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,h.sendResponse)(B,K,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};j?await d(j):await q.withPropagatedContext(e.headers,()=>q.trace(p.BaseServerSpan.handleRequest,{spanName:`${H} ${r}`,kind:o.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},d))}catch(t){if(t instanceof w.NoFallbackError||await y.onRequestError(e,t,{routerKind:"App Router",routePath:U,routeType:"route",revalidateReason:(0,m.getRevalidateReason)({isStaticGeneration:F,isOnDemandRevalidate:x})},!1,C),O)throw t;return await (0,h.sendResponse)(B,K,new Response(null,{status:500})),null}}e.s(["handler",()=>I,"patchFetch",()=>A,"routeModule",()=>y,"serverHooks",()=>C,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>b]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_ab871d92._.js.map