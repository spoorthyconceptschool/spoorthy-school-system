module.exports=[43723,e=>e.a(async(t,a)=>{try{var r=e.i(89171),s=e.i(73051),o=e.i(27817),n=e.i(89174),i=t([o,n]);async function l(e){try{let t=e.headers.get("Authorization");if(!t?.startsWith("Bearer "))return r.NextResponse.json({error:"Unauthorized"},{status:401});let a=t.split("Bearer ")[1];if("undefined"===a)return r.NextResponse.json({error:"Invalid Auth Token. Please refresh page."},{status:401});let i=await s.adminAuth.verifyIdToken(a),l=await s.adminDb.collection("users").doc(i.uid).get(),d=l.data()?.role||i.role||"UNKNOWN",u=l.data()?.name||i.name||"Manager",{leaveId:c,action:p,yearId:h="2025-2026"}=await e.json();if(!c||!p)return r.NextResponse.json({error:"Missing leaveId or action"},{status:400});let v=s.adminDb.collection("leave_requests").doc(c),m=await v.get();if(!m.exists)return r.NextResponse.json({error:"Leave request not found"},{status:404});let g=m.data();if("REVERT"===p){let e=s.adminDb.batch(),t=await s.adminDb.collection("coverage_tasks").where("leaveRequestId","==",c).get(),a=t.docs.map(e=>e.id);if(t.docs.forEach(t=>e.delete(t.ref)),a.length>0)for(let t=0;t<a.length;t+=10){let r=a.slice(t,t+10);(await s.adminDb.collection("substitutions").where("taskId","in",r).get()).docs.forEach(t=>e.delete(t.ref))}return e.update(v,{status:"PENDING",revertedBy:i.uid,revertedAt:o.FieldValue.serverTimestamp(),coverageTasksCount:0}),await e.commit(),r.NextResponse.json({success:!0,message:"Leave moved back to Pending"})}if(g?.status!=="PENDING")return r.NextResponse.json({error:`Leave is already ${g?.status}`},{status:400});if("REJECT"===p)return await v.update({status:"REJECTED",reviewedBy:i.uid,reviewedAt:o.FieldValue.serverTimestamp()}),"MANAGER"===d&&await (0,n.notifyManagerActionServer)({userId:g.teacherId,title:"Leave Request Rejected",message:`Your leave request from ${g.fromDate} to ${g.toDate} has been REJECTED by Manager ${u}.`,type:"ERROR",actionBy:i.uid,actionByName:u}),r.NextResponse.json({success:!0,message:"Leave Rejected"});let R=g?.teacherId,f=g?.fromDate,E=g?.toDate;if(!R||!f||!E)return r.NextResponse.json({error:"Invalid leave data"},{status:400});let w=new Date(f),A=new Date(E);try{let e=await s.adminDb.collection("teachers").where("uid","==",R).limit(1).get();if(e.empty)return r.NextResponse.json({error:"Teacher profile not found"},{status:404});let t=e.docs[0].data(),a=t.schoolId||e.docs[0].id,l=t.name||"Teacher",p=await s.adminDb.collection("teacher_schedules").doc(`${h}_${a}`).get(),m=p.exists&&p.data()?.schedule||{};if(!m||0===Object.keys(m).length)return await v.update({status:"APPROVED",reviewedBy:i.uid,reviewedAt:o.FieldValue.serverTimestamp(),note:"No schedule found"}),r.NextResponse.json({success:!0,message:"Leave Approved (No schedule)"});let g=(await s.adminDb.collection("teachers").where("status","==","ACTIVE").get()).docs.map(e=>{let t=e.data();return{uid:t.uid,schoolId:t.schoolId||e.id,name:t.name}}),[D,N,y]=await Promise.all([s.adminDb.collection("teacher_schedules").get(),s.adminDb.collection("teaching_assignments").get(),s.adminDb.collection("leave_requests").where("status","==","APPROVED").get()]),T={};D.docs.forEach(e=>{T[e.id.split("_").pop()||e.id]=e.data()?.schedule||{}});let b={};N.docs.forEach(e=>{b[e.id.split("_").pop()||e.id]=e.data()?.assignments||{}});let I=y.docs.map(e=>e.data()),C=(function(e,t){let a=[],r=new Date(e);for(;r<=t;)a.push(new Date(r)),r.setDate(r.getDate()+1);return a})(w,A).map(e=>e.toISOString().split("T")[0]),x=[];C.forEach(e=>{let t=new Date(e).toLocaleDateString("en-US",{weekday:"long"}).toUpperCase(),r=m[t];r&&Object.entries(r).forEach(([r,s])=>{let n=s?.classId;if(!n)return;let i=g.filter(a=>{if(a.uid===R||I.some(t=>t.teacherId===a.uid&&e>=t.fromDate&&e<=t.toDate))return!1;let s=T[a.schoolId];return!s?.[t]?.[r]}),l=null,d="SUBSTITUTE",u=i.filter(e=>{let t=b[n];return t&&Object.values(t).includes(e.schoolId)});u.length>0?(l=u[0].schoolId,d="SUBSTITUTE"):i.length>0?(l=i[0].schoolId,d="SUBSTITUTE"):(l=null,d="LEISURE"),x.push({leaveRequestId:c,originalTeacherId:a,date:e,day:t,slotId:Number(r),classId:n,subjectId:s.subjectId||null,status:"PENDING",suggestedSubstituteId:l,suggestedType:d,createdAt:o.FieldValue.serverTimestamp()})})});let P=s.adminDb.batch();P.update(v,{status:"APPROVED",reviewedBy:i.uid,reviewedAt:o.FieldValue.serverTimestamp(),coverageTasksCount:x.length}),x.forEach(e=>{let t=s.adminDb.collection("coverage_tasks").doc();P.set(t,{id:t.id,...e})});let S=s.adminDb.collection("notifications");P.set(S.doc(),{userId:R,type:"LEAVE_APPROVED",title:"Leave Approved",message:`Your leave request from ${f} to ${E} has been approved.`,status:"UNREAD",createdAt:o.FieldValue.serverTimestamp()}),P.set(S.doc(),{type:"ADMIN_ACTION_REQUIRED",target:"ALL_ADMINS",title:"New Coverage Needed",message:`${l} is on leave. ${x.length} classes need coverage resolution.`,data:{leaveId:c,teacherName:l},status:"UNREAD",createdAt:o.FieldValue.serverTimestamp()}),await P.commit();try{let e=s.adminDb.batch(),t=!1,r=C.map(e=>s.adminDb.collection("attendance").doc(`TEACHERS_${e}`));r.length>0&&((await s.adminDb.getAll(...r)).forEach(r=>{r.exists&&(e.update(r.ref,{[`records.${a}`]:"A"}),t=!0)}),t&&await e.commit())}catch(e){console.error("Failed to auto-update attendance for leave approval:",e)}return"MANAGER"===d&&await (0,n.notifyManagerActionServer)({userId:R,title:"Leave Approved",message:`Your leave request from ${f} to ${E} has been APPROVED by Manager ${u}. ${x.length} coverage slots proposed.`,type:"SUCCESS",actionBy:i.uid,actionByName:u}),r.NextResponse.json({success:!0,message:`Leave Approved! ${x.length} coverage slots proposed for review.`})}catch(e){return console.error("[Leave Approve] Coverage generation failed:",e),await v.update({status:"APPROVED",reviewedBy:i.uid,reviewedAt:o.FieldValue.serverTimestamp(),coverageError:e.message}),r.NextResponse.json({success:!0,message:"Leave Approved (Recommendation engine failed)"})}}catch(e){return console.error("[Leave Approve Error]:",e),r.NextResponse.json({error:e.message||"Failed to process leave request"},{status:500})}}[o,n]=i.then?(await i)():i,e.s(["POST",()=>l]),a()}catch(e){a(e)}},!1),34740,e=>e.a(async(t,a)=>{try{var r=e.i(47909),s=e.i(74017),o=e.i(96250),n=e.i(59756),i=e.i(61916),l=e.i(74677),d=e.i(69741),u=e.i(16795),c=e.i(87718),p=e.i(95169),h=e.i(47587),v=e.i(66012),m=e.i(70101),g=e.i(26937),R=e.i(10372),f=e.i(93695);e.i(52474);var E=e.i(220),w=e.i(43723),A=t([w]);[w]=A.then?(await A)():A;let y=new r.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/admin/leaves/approve/route",pathname:"/api/admin/leaves/approve",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/admin/leaves/approve/route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:T,workUnitAsyncStorage:b,serverHooks:I}=y;function D(){return(0,o.patchFetch)({workAsyncStorage:T,workUnitAsyncStorage:b})}async function N(e,t,a){y.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let r="/api/admin/leaves/approve/route";r=r.replace(/\/index$/,"")||"/";let o=await y.prepare(e,t,{srcPage:r,multiZoneDraftMode:!1});if(!o)return t.statusCode=400,t.end("Bad Request"),null==a.waitUntil||a.waitUntil.call(a,Promise.resolve()),null;let{buildId:w,params:A,nextConfig:D,parsedUrl:N,isDraftMode:T,prerenderManifest:b,routerServerContext:I,isOnDemandRevalidate:C,revalidateOnlyGenerated:x,resolvedPathname:P,clientReferenceManifest:S,serverActionsManifest:O}=o,_=(0,d.normalizeAppPath)(r),U=!!(b.dynamicRoutes[_]||b.routes[P]),j=async()=>((null==I?void 0:I.render404)?await I.render404(e,t,N,!1):t.end("This page could not be found"),null);if(U&&!T){let e=!!b.routes[P],t=b.dynamicRoutes[_];if(t&&!1===t.fallback&&!e){if(D.experimental.adapterPath)return await j();throw new f.NoFallbackError}}let $=null;!U||y.isDev||T||($=P,$="/index"===$?"/":$);let q=!0===y.isDev||!U,k=U&&!q;O&&S&&(0,l.setManifestsSingleton)({page:r,clientReferenceManifest:S,serverActionsManifest:O});let L=e.method||"GET",M=(0,i.getTracer)(),V=M.getActiveScopeSpan(),B={params:A,prerenderManifest:b,renderOpts:{experimental:{authInterrupts:!!D.experimental.authInterrupts},cacheComponents:!!D.cacheComponents,supportsDynamicResponse:q,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:D.cacheLife,waitUntil:a.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,a,r,s)=>y.onRequestError(e,t,r,s,I)},sharedContext:{buildId:w}},F=new u.NodeNextRequest(e),H=new u.NodeNextResponse(t),K=c.NextRequestAdapter.fromNodeNextRequest(F,(0,c.signalFromNodeResponse)(t));try{let o=async e=>y.handle(K,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let a=M.getRootSpanAttributes();if(!a)return;if(a.get("next.span_type")!==p.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${a.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=a.get("next.route");if(s){let t=`${L} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${L} ${r}`)}),l=!!(0,n.getRequestMeta)(e,"minimalMode"),d=async n=>{var i,d;let u=async({previousCacheEntry:s})=>{try{if(!l&&C&&x&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let r=await o(n);e.fetchMetrics=B.renderOpts.fetchMetrics;let i=B.renderOpts.pendingWaitUntil;i&&a.waitUntil&&(a.waitUntil(i),i=void 0);let d=B.renderOpts.collectedTags;if(!U)return await (0,v.sendResponse)(F,H,r,B.renderOpts.pendingWaitUntil),null;{let e=await r.blob(),t=(0,m.toNodeOutgoingHttpHeaders)(r.headers);d&&(t[R.NEXT_CACHE_TAGS_HEADER]=d),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let a=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=R.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,s=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=R.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:E.CachedRouteKind.APP_ROUTE,status:r.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:a,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await y.onRequestError(e,t,{routerKind:"App Router",routePath:r,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:C})},!1,I),t}},c=await y.handleResponse({req:e,nextConfig:D,cacheKey:$,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:b,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:x,responseGenerator:u,waitUntil:a.waitUntil,isMinimalMode:l});if(!U)return null;if((null==c||null==(i=c.value)?void 0:i.kind)!==E.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});l||t.setHeader("x-nextjs-cache",C?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),T&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let p=(0,m.fromNodeOutgoingHttpHeaders)(c.value.headers);return l&&U||p.delete(R.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||p.get("Cache-Control")||p.set("Cache-Control",(0,g.getCacheControlHeader)(c.cacheControl)),await (0,v.sendResponse)(F,H,new Response(c.value.body,{headers:p,status:c.value.status||200})),null};V?await d(V):await M.withPropagatedContext(e.headers,()=>M.trace(p.BaseServerSpan.handleRequest,{spanName:`${L} ${r}`,kind:i.SpanKind.SERVER,attributes:{"http.method":L,"http.target":e.url}},d))}catch(t){if(t instanceof f.NoFallbackError||await y.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,h.getRevalidateReason)({isStaticGeneration:k,isOnDemandRevalidate:C})},!1,I),U)throw t;return await (0,v.sendResponse)(F,H,new Response(null,{status:500})),null}}e.s(["handler",()=>N,"patchFetch",()=>D,"routeModule",()=>y,"serverHooks",()=>I,"workAsyncStorage",()=>T,"workUnitAsyncStorage",()=>b]),a()}catch(e){a(e)}},!1)];

//# sourceMappingURL=_52016724._.js.map