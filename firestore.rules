rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Basic Helper Functions
    function isSignedIn() {
      return request.auth != null;
    }
    
    function getRole() {
      let role = request.auth.token.role != null 
        ? request.auth.token.role 
        : (exists(/databases/$(database)/documents/users/$(request.auth.uid))
           ? get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role
           : null);
      return role;
    }
    
    function isAdmin() {
      let r = getRole();
      return isSignedIn() && (r == 'ADMIN' || r == 'SUPER_ADMIN' || r == 'admin' || r == 'super_admin');
    }

    function isManager() {
      let r = getRole();
      return isSignedIn() && (r == 'MANAGER' || r == 'manager' || isAdmin());
    }

    function isTeacher() {
      let r = getRole();
      return isSignedIn() && (r == 'TEACHER' || r == 'teacher');
    }

    // --- COLLECTION RULES ---

    // Admin-only collections (Audit, Analytics)
    match /audit_logs/{log} { allow read, write: if isManager(); }
    match /analytics/{doc} { allow read, write: if isManager(); }
    
    // Core Config (Academic years needed for Landing Page/Context)
    match /config/academic_years { allow read: if true; allow write: if isAdmin(); }
    match /config/{doc} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    
    match /settings/{doc} { allow read: if isSignedIn(); allow write: if isAdmin(); }

    // Master Data (Public Read allowed for landing page/admissions)
    match /master_classes/{doc} { allow read: if true; allow write: if isAdmin(); }
    match /master_sections/{doc} { allow read: if true; allow write: if isAdmin(); }
    match /master_villages/{doc} { allow read: if true; allow write: if isAdmin(); }
    match /master_subjects/{doc} { allow read: if true; allow write: if isAdmin(); }
    match /master_staff_roles/{doc} { allow read: if true; allow write: if isAdmin(); }
    match /master_class_sections/{doc} { allow read: if true; allow write: if isAdmin(); }

    // Users Collection
    match /users/{userId} {
      allow read: if isSignedIn() && (request.auth.uid == userId || isManager());
      allow write: if isAdmin();
    }

    // Students & Teachers
    match /students/{studentId} {
      allow read: if isSignedIn() && (
        request.auth.uid == studentId || 
        request.auth.uid == resource.data.uid || 
        request.auth.email.split('@')[0].upper() == studentId ||
        isManager() || 
        isTeacher()
      );
      allow write: if isManager();
    }
    
    match /teachers/{teacherId} {
      allow read: if isSignedIn() && (request.auth.uid == teacherId || resource.data.uid == request.auth.uid || isManager());
      allow write: if isManager();
    }

    // Academic & Operations
    match /exam_results/{id} {
      allow read: if isSignedIn() && (request.auth.uid == resource.data.studentId || isManager() || isTeacher());
      allow write: if isManager(); // Forced via backend
    }

    match /homework/{id} {
      allow read: if isSignedIn();
      allow write: if isManager() || isTeacher();
    }
    
    match /attendance/{id} {
      allow read: if isSignedIn() && (isManager() || isTeacher() || getRole() == 'STUDENT' || getRole() == 'student');
      allow write: if isManager(); // Forced via backend to validate time windows and read-only
    }
    
    match /student_fee_ledgers/{id} { 
      allow read: if isSignedIn() && (
        isManager() || 
        request.auth.uid == resource.data.uid || 
        request.auth.uid == resource.data.studentId ||
        request.auth.email.split('@')[0].upper() == resource.data.studentId
      ); 
      allow write: if isManager(); 
    }

    match /payments/{id} { 
      allow read: if isSignedIn() && (
        isManager() || 
        request.auth.uid == resource.data.uid || 
        request.auth.uid == resource.data.studentId ||
        request.auth.email.split('@')[0].upper() == resource.data.studentId
      ); 
      allow write: if isManager(); 
    }
    match /invoices/{id} { 
      allow read: if isSignedIn() && (
        isManager() || 
        request.auth.uid == resource.data.uid || 
        request.auth.uid == resource.data.studentId ||
        request.auth.email.split('@')[0].upper() == resource.data.studentId
      ); 
      allow write: if isManager(); 
    }

    // Communication & Notices
    match /notices/{id} {
      allow read: if isSignedIn();
      allow write: if isManager() || isTeacher();
    }

    match /notifications/{id} {
      allow read: if isSignedIn() && (
        resource.data.target == 'ALL' || 
        resource.data.target == 'ALL_STUDENTS' || 
        resource.data.userId == request.auth.uid ||
        // Allow if userId matches the ID of a student doc owned by this user
        (
           exists(/databases/$(database)/documents/students/$(resource.data.userId)) &&
           get(/databases/$(database)/documents/students/$(resource.data.userId)).data.uid == request.auth.uid
        ) ||
        isManager()
      );
      allow write: if isManager();
    }

    // Leave Management
    match /student_leaves/{id} {
      allow read: if isSignedIn() && (
        resource.data.uid == request.auth.uid || 
        isManager() || 
        isTeacher()
      );
      allow create: if isSignedIn() && (getRole() == 'STUDENT' || getRole() == 'student');
      allow update, delete: if isManager();
    }

    // Search Index
    match /search_index/{id} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    // Global Catch-all (Default to Admin only for safety)
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
